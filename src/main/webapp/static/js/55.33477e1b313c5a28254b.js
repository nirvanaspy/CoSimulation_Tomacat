webpackJsonp([55],{"2bll":function(t,e,i){var a=i("SFzD");"string"==typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);i("rjj0")("66d2f141",a,!0)},Bajr:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=i("cwNs"),s=i("XlQU"),o=i("GLLG"),n={name:"taskFiles",data:function(){return{signType:0,selectedId:"",userId:"",currentSubtask:null,selectdName:"",applyForEditDialog:!1,commitDialog:!1,getMaLoading:!1,userList:[],verifyMembers:[],auditMembers:[],signMembers:[],approveMembers:[],activeNames:"",proSecretClass:null,countersignList:[],commitLoading:!1,showSecondEditApply:!1,ableToCommit:!1,subtaskName:"",commitType:"",rules:{applyVersion:[{required:!0,message:"请选择版本",trigger:"change"}]},applyForm:{applyVersion:""},ifToStartOptions:[{label:"提交到初始审核流程",value:!0},{label:"提交到被驳回的审核流程",value:!1}],ifBackToStart:!0,taskName:"",taskState:null,taskIfPass:!1,myTimer:null}},components:{comFileManage:a.default},created:function(){var t=this;this.userId=this.getCookie("userId"),this.selectedId=":id"!==this.$route.params.id?this.$route.params.id:this.getCookie("taskSelectedId"),this.taskName=this.$route.query.name?this.$route.query.name:decodeURI(unescape(this.getCookie("taskSelectedName"))),this.proSecretClass=this.$route.query.proClass?parseInt(this.$route.query.proClass):parseInt(this.getCookie("taskSelectedClass")),this.getSubtaskDetails(),this.myTimer&&clearInterval(this.myTimer),this.myTimer=setInterval(function(){t.refreshSubTaskDetail(),t.$refs.fileComp.refreshFileList()},2e4)},destroyed:function(){this.myTimer&&clearInterval(this.myTimer)},methods:{routerToDevice:function(){this.$router.push({path:"/device/device",name:"device",params:{id:this.selectedId}})},refreshSubTaskDetail:function(){var t=this;Object(o.p)(this.selectedId).then(function(e){if(0===e.data.code){var i=e.data.data;t.currentSubtask=e.data.data,t.taskState=i.state,t.taskIfPass=i.ifApprove,9===i.state?t.$refs.fileComp.onSecondEditing=!0:t.$refs.fileComp.onSecondEditing=!1,7!==i.state||!0!==i.ifApprove&&!0!==i.ifReject?t.showSecondEditApply=!1:t.showSecondEditApply=!0,1===i.state||9===i.state||7===i.state&&!0===i.ifReject&&t.userId===i.users.id?(t.$refs.fileComp.showUploadFlag=!0,t.ableToCommit=!0):(t.$refs.fileComp.showUploadFlag=!1,t.ableToCommit=!1)}else t.ableToCommit=!0,t.$refs.fileComp.showUploadFlag=!0})},getSubtaskDetails:function(){var t=this;this.$nextTick(function(){t.ableToCommit=!1,t.$refs.fileComp.showUploadFlag=!1}),Object(o.p)(this.selectedId).then(function(e){if(0===e.data.code){var i=e.data.data;if(t.currentSubtask=e.data.data,t.taskState=i.state,t.taskIfPass=i.ifApprove,t.userId!==i.users.id)return t.$refs.fileComp.showUploadFlag=!1,void(t.ableToCommit=!1);9===i.state?t.$refs.fileComp.onSecondEditing=!0:t.$refs.fileComp.onSecondEditing=!1,7!==i.state||!0!==i.ifApprove&&!0!==i.ifReject?t.showSecondEditApply=!1:t.showSecondEditApply=!0,1===i.state||9===i.state||7===i.state&&!0===i.ifReject?(t.$refs.fileComp.showUploadFlag=!0,t.ableToCommit=!0):(t.$refs.fileComp.showUploadFlag=!1,t.ableToCommit=!1)}else t.ableToCommit=!0,t.$refs.fileComp.showUploadFlag=!0})},getAbleUser:function(){var t=this;this.getMaLoading=!0,Object(s.d)().then(function(e){if(0===e.data.code){t.userList=[],e.data.data.forEach(function(e){"admin"!==e.username&&"securityGuard"!==e.username&&"securityAuditor"!==e.username&&t.userList.push(e)}),t.countersignList=t.userList.slice(0);for(var i=0;i<t.countersignList.length;i++)if(t.countersignList[i].id===t.userId){t.countersignList.splice(i,1);break}t.getMaLoading=!1}else t.getMaLoading=!1}).catch(function(){t.getMaLoading=!1})},handleVerifySelectionChange:function(t){this.verifyMembers=t},handleAuditSelectionChange:function(t){this.auditMembers=t},handleSignSelectionChange:function(t){this.signMembers=t},handleApproveSelectionChange:function(t){this.approveMembers=t},handleCommit:function(){var t=this;if(0!==this.$refs.fileComp.list.length){for(var e=0;e<this.$refs.fileComp.list.length;e++)if(this.$refs.fileComp.list[e].subDepotSet.length>1)return void this.$confirm("库中有文件同时属于多个库，确认继续提交吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){t.commitDialog=!0,t.signType=0,t.getAbleUser()}).catch(function(){});var i=this.$refs.fileComp.list[0].subtask;1==i.state&&0==i.ifReject&&0==i.ifApprove&&(this.commitType="firstCommit"),7==i.state&&1==i.ifReject&&(this.commitType="editCommit"),9==i.state&&(this.commitType="secondCommit"),i&&(this.commitDialog=!0),this.signType=0,this.getAbleUser(),this.getSubtaskDetails()}else this.$notify({title:"失败",message:"请先上传子任务文件",type:"error",duration:2e3})},commitToAuditor:function(){var t=this,e=[],a=[],s=[],n=[];if(this.verifyMembers.forEach(function(t){e.push(t.id)}),this.auditMembers.forEach(function(t){a.push(t.id)}),this.signMembers.forEach(function(t){s.push(t.id)}),this.approveMembers.forEach(function(t){n.push(t.id)}),!0===this.ifBackToStart){if(0===e.length)return void this.$message({message:"请选择校对人",type:"warning"});if(0===a.length)return void this.$message({message:"请选择审核人",type:"warning"});if(0===s.length&&1!==this.signType)return void this.$message({message:"请选择会签人",type:"warning"});if(0===n.length)return void this.$message({message:"请选择批准人",type:"warning"})}var l=(e+"").replace(/\[|]/g,""),r=(a+"").replace(/\[|]/g,""),c=(s+"").replace(/\[|]/g,""),p=(n+"").replace(/\[|]/g,""),d=i("mw3O"),u={proofreadUserIds:l,auditUserIds:r,countersignUserIds:1===this.signType?"":c,approveUserIds:p,commitMode:0,auditMode:this.signType,userId:this.userId,ifBackToStart:"editCommit"===this.commitType&&this.ifBackToStart};"firstCommit"===this.commitType?u.commitMode=0:"editCommit"===this.commitType?u.commitMode=1:"secondCommit"===this.commitType&&(u.commitMode=2);var m=d.stringify(u);this.commitLoading=!0,Object(o.w)(this.selectedId,m).then(function(e){0===e.data.code?(t.$notify({title:"成功",message:"设置成功",type:"success",duration:2e3}),t.commitDialog=!1):t.$notify({title:"失败",message:e.data.msg,type:"error",duration:2e3}),t.commitLoading=!1,t.getSubtaskDetails()}).catch(function(){t.$notify({title:"失败",message:"提交失败",type:"error",duration:2e3}),t.commitLoading=!1})},handleApplySecondEdit:function(){var t=this;this.applyForm.applyVersion="",this.applyForEditDialog=!0,this.$nextTick(function(){t.$refs.applyForm.clearValidate})},resetApplyForm:function(){this.applyForEditDialog=!1,this.applyForm.applyVersion="",this.$refs.applyForm.clearValidate},applyForEdit:function(){var t=this;this.$refs.applyForm.validate(function(e){if(e){var a=i("mw3O").stringify({version:t.applyForm.applyVersion,userId:t.userId});Object(o.a)(t.selectedId,a).then(function(e){0===e.data.code?(t.$notify({title:"成功",message:"申请成功",type:"success",duration:2e3}),t.resetApplyForm(),t.getSubtaskDetails()):t.$notify({title:"失败",message:e.data.msg,type:"error",duration:2e3})})}})}},computed:{computeList:function(){return 3===this.signType?this.countersignList:this.userList},computeVersionOption:function(){var t=[];if(this.currentSubtask)if(this.currentSubtask.version){var e=this.currentSubtask.version.substring(0,1),i=void 0;!0===this.currentSubtask.ifApprove?(i=parseInt(this.currentSubtask.version.substring(1,this.currentSubtask.version.length))+1,"M"===e&&(t=[{value:"M"+i},{value:"C1"}]),"C"===e&&(t=[{value:"C"+i},{value:"S1"}]),"S"===e&&(t=[{value:"S"+i},{value:"D1"}]),"D"===e&&(t=[{value:"D"+i}])):(i=parseInt(this.currentSubtask.version.substring(1,this.currentSubtask.version.length)),"M"===e&&(t=[{value:"M"+i}]),"C"===e&&(t=[{value:"C"+i}]),"S"===e&&(t=[{value:"S"+i}]),"D"===e&&(t=[{value:"D"+i}]))}else t=[{value:"M2"},{value:"C1"}];return t},computeCurrentState:function(){return null===this.taskState?"--":0===this.taskState?"未开始":1===this.taskState?"进行中":2===this.taskState?"待审批":3===this.taskState?"校对中":4===this.taskState?"审核中":5===this.taskState?"会签中":6===this.taskState?"批准中":7===this.taskState?!0===this.taskIfPass?"审批结束 已通过":!1===this.taskIfPass?"审批结束 已驳回":"审批结束":8===this.taskState?"申请二次修改中":9===this.taskState?"二次修改中":10===this.taskState?"二次修改审批中":void 0},computeShowBtn:function(){return function(t){var e=!1,i=void 0;if(t){if(!t[0])return!1;7!==(i=t[0].subtask).state||!0!==i.ifApprove&&!0!==i.ifReject||(e=!0)}return e}}}},l={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"app-container calendar-list-container",attrs:{id:"components"}},[t.selectedId?i("div",[i("div",{staticClass:"task-text"},[i("span",{staticClass:"text"},[t._v(t._s(t.taskName))]),t._v(" "),"审批结束 已通过"===t.computeCurrentState?i("span",{staticClass:"text",staticStyle:{color:"#67C23A"}},[t._v(t._s(t.computeCurrentState))]):i("span",{staticClass:"text",staticStyle:{color:"#e6a23c"}},[t._v(t._s(t.computeCurrentState))])]),t._v(" "),i("span",{staticClass:"task-detail"},[i("el-button",{attrs:{type:"primary",size:"mini",disabled:!t.ableToCommit},on:{click:t.handleCommit}},[t._v("提交审核")]),t._v(" "),t.showSecondEditApply?i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:t.handleApplySecondEdit}},[t._v("申请二次修改")]):t._e(),t._v(" "),t.taskState>0?i("el-button",{attrs:{type:"success",size:"mini"},on:{click:t.routerToDevice}},[t._v("预定设备")]):t._e()],1),t._v(" "),i("div",{staticStyle:{height:"100%",overflow:"auto",width:"100%",padding:"5px 0 10px 10px"}},[i("comFileManage",{ref:"fileComp",attrs:{selectCompId:t.selectedId,selectCompName:t.selectdName,proClass:t.proSecretClass,taskInfo:t.currentSubtask}})],1)]):i("div",{staticStyle:{"text-align":"center",color:"#555","font-size":"18px"}},[t._v("\n    还没有选择子任务,请进入项目管理页面进行选择！\n  ")]),t._v(" "),i("el-dialog",{staticClass:"limit-width-dialog audit-dialog",attrs:{title:"申请二次修改",visible:t.applyForEditDialog,"append-to-body":"",width:"60%"},on:{"update:visible":function(e){t.applyForEditDialog=e}}},[i("el-form",{ref:"applyForm",attrs:{"label-position":"left","label-width":"80px",rules:t.rules,model:t.applyForm}},[i("el-form-item",{attrs:{label:"审批流程",prop:"applyVersion"}},[i("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择要修改至何版本"},model:{value:t.applyForm.applyVersion,callback:function(e){t.$set(t.applyForm,"applyVersion",e)},expression:"applyForm.applyVersion"}},t._l(t.computeVersionOption,function(t){return i("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})}))],1)],1),t._v(" "),i("div",{staticClass:"dialog-footer",staticStyle:{"text-align":"right"},attrs:{slot:"footer"},slot:"footer"},[i("el-button",{staticStyle:{"margin-top":"10px"},on:{click:t.resetApplyForm}},[t._v("取消")]),t._v(" "),i("el-button",{staticStyle:{"margin-top":"10px"},attrs:{type:"primary"},on:{click:t.applyForEdit}},[t._v("确定")])],1)],1),t._v(" "),i("el-dialog",{staticClass:"limit-width-dialog audit-dialog",attrs:{title:"选择审核人",visible:t.commitDialog,"append-to-body":"",width:"60%"},on:{"update:visible":function(e){t.commitDialog=e}}},[i("el-form",{attrs:{"label-position":"left","label-width":"80px"}},["editCommit"===t.commitType?i("el-form-item",{attrs:{label:"审批流程"}},[i("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择提交的目标审批流程"},model:{value:t.ifBackToStart,callback:function(e){t.ifBackToStart=e},expression:"ifBackToStart"}},t._l(t.ifToStartOptions,function(t){return i("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})}))],1):t._e(),t._v(" "),"editCommit"!==t.commitType||!1!==t.ifBackToStart?i("el-form-item",{attrs:{label:"会签模式"}},[i("el-radio-group",{model:{value:t.signType,callback:function(e){t.signType=e},expression:"signType"}},[i("el-radio",{attrs:{label:1}},[t._v("无会签")]),t._v(" "),i("el-radio",{attrs:{label:2}},[t._v("一人会签通过")]),t._v(" "),i("el-radio",{attrs:{label:3}},[t._v("多人会签通过")])],1)],1):t._e()],1),t._v(" "),"editCommit"!==t.commitType||!1!==t.ifBackToStart?i("el-collapse",{staticClass:"audit-collapse",attrs:{accordion:""},model:{value:t.activeNames,callback:function(e){t.activeNames=e},expression:"activeNames"}},[i("el-collapse-item",{attrs:{title:"选择校对人",name:"1"}},[i("div",[i("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.getMaLoading,expression:"getMaLoading"}],ref:"multipleTable",staticStyle:{width:"100%"},attrs:{data:t.userList,"tooltip-effect":"dark"},on:{"selection-change":t.handleVerifySelectionChange}},[i("el-table-column",{attrs:{type:"selection",width:"55"}}),t._v(" "),i("el-table-column",{attrs:{label:"用户名","min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.realName))]}}])})],1)],1)]),t._v(" "),i("el-collapse-item",{attrs:{title:"选择审核人",name:"2"}},[i("div",[i("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.getMaLoading,expression:"getMaLoading"}],ref:"multipleTable",staticStyle:{width:"100%"},attrs:{data:t.userList,"tooltip-effect":"dark"},on:{"selection-change":t.handleAuditSelectionChange}},[i("el-table-column",{attrs:{type:"selection",width:"55"}}),t._v(" "),i("el-table-column",{attrs:{label:"用户名","min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.realName))]}}])})],1)],1)]),t._v(" "),2===t.signType||3===t.signType?i("el-collapse-item",{attrs:{title:"选择会签人",name:"3"}},[i("div",[i("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.getMaLoading,expression:"getMaLoading"}],ref:"multipleTable",staticStyle:{width:"100%"},attrs:{data:t.computeList,"tooltip-effect":"dark"},on:{"selection-change":t.handleSignSelectionChange}},[i("el-table-column",{attrs:{type:"selection",width:"55"}}),t._v(" "),i("el-table-column",{attrs:{label:"用户名","min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.realName))]}}])})],1)],1)]):t._e(),t._v(" "),i("el-collapse-item",{attrs:{title:"选择批准人",name:"4"}},[i("div",[i("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.getMaLoading,expression:"getMaLoading"}],ref:"multipleTable",staticStyle:{width:"100%"},attrs:{data:t.userList,"tooltip-effect":"dark"},on:{"selection-change":t.handleApproveSelectionChange}},[i("el-table-column",{attrs:{type:"selection",width:"55"}}),t._v(" "),i("el-table-column",{attrs:{label:"用户名","min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.realName))]}}])})],1)],1)])],1):t._e(),t._v(" "),i("div",{staticClass:"dialog-footer",staticStyle:{"text-align":"right"},attrs:{slot:"footer"},slot:"footer"},[i("el-button",{staticStyle:{"margin-top":"10px"},attrs:{type:"primary",loading:t.commitLoading},on:{click:t.commitToAuditor}},[t._v("确定")])],1)],1)],1)},staticRenderFns:[]};var r=i("VU/8")(n,l,!1,function(t){i("2bll")},"data-v-39168620",null);e.default=r.exports},SFzD:function(t,e,i){(t.exports=i("FZ+f")(!1)).push([t.i,"\n.el-button+.el-button[data-v-39168620] {\n  margin-left: 0;\n}\n.el-dialog__body[data-v-39168620] {\n  padding: 30px 20px;\n  color: #606266;\n  line-height: 24px;\n  font-size: 14px;\n  height: 440px;\n  overflow-y: auto;\n}\n.el-dialog[data-v-39168620] {\n  margin-top: 10vh;\n}\n.button-container[data-v-39168620]{\n  position: absolute;\n  bottom: 0;\n  right: 15px;\n}\n.popover-close[data-v-39168620] {\n  display: block;\n  text-align: right;\n  font-size: 20px;\n}\n.close-icon[data-v-39168620] {\n  cursor: pointer;\n}\n.icon-show-popover[data-v-39168620] {\n  cursor: pointer;\n  color: #337ab7;\n}\n.task-detail[data-v-39168620] {\n  position: absolute;\n  top: 88px;\n  left: 30px;\n}\n.task-text[data-v-39168620] {\n  display: block;\n  height: 20px;\n  position: absolute;\n  top: 66px;\n  left: 32px;\n}\n.task-text .text[data-v-39168620] {\n  font-size: 12px;\n  color: #777;\n  margin-right: 10px;\n  display: inline-block;\n}\n",""])}});